{% extends "base.html" %}
{% block lab %}Лабораторная работа 6{% endblock %}

{% block script %}
<script>
// Функция для получения списка офисов
function getOfficeList() {
    const url = '/lab6/json-rpc-api';
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            handleError(data.error);
        } else {
            updateOfficeList(data.result);
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Произошла ошибка при загрузке данных');
    });
}

// Функция для обработки ошибок
function handleError(error) {
    switch(error.code) {
        case 1:
            alert('Вы не авторизованы, пожалуйста, авторизуйтесь');
            break;
        case 2:
            alert('Офис уже арендован');
            break;
        case 3:
            alert('Офис не арендован');
            break;
        case 4:
            alert('Вы можете снять только свою аренду');
            break;
        case -32601:
            alert('Метод не найден');
            break;
        default:
            alert('Неизвестная ошибка: ' + error.message);
    }
}

// Функция для обновления списка офисов на странице
function updateOfficeList(officeList) {
    const ul = document.getElementById('office-list');
    ul.innerHTML = '';
    
    let totalCost = 0;
    let userBookings = 0;
    const login = '{{ session.get("login", "") }}'; // Получаем логин из сессии
    
    officeList.forEach(function(office) {
        const li = document.createElement('li');
        li.style.margin = '10px 0';
        li.style.padding = '10px';
        li.style.border = '1px solid #ccc';
        li.style.borderRadius = '5px';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        
        // Отображение информации об офисе
        const officeInfo = document.createElement('div');
        officeInfo.style.flex = '1';
        
        const statusText = office.tenant ? 
            `занят (${office.tenant})` : 
            'свободен';
        
        officeInfo.innerHTML = `
            <strong>Офис ${office.number}</strong><br>
            Статус: ${statusText}<br>
            Стоимость: <strong>${office.price} руб.</strong>
        `;
        li.appendChild(officeInfo);
        
        // Подсчет общей стоимости для текущего пользователя
        if (office.tenant === login) {
            totalCost += office.price;
            userBookings++;
        }
        
        // Создание кнопок в зависимости от статуса офиса
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginLeft = '10px';
        
        if (!office.tenant) {
            // Кнопка бронирования для свободного офиса
            const bookButton = document.createElement('button');
            bookButton.textContent = 'Забронировать';
            bookButton.style.padding = '8px 15px';
            bookButton.style.backgroundColor = '#4CAF50';
            bookButton.style.color = 'white';
            bookButton.style.border = 'none';
            bookButton.style.borderRadius = '3px';
            bookButton.style.cursor = 'pointer';
            bookButton.onclick = function() { 
                bookOffice(office.number); 
            };
            buttonContainer.appendChild(bookButton);
        } else {
            // Кнопка освобождения для занятого офиса
            const freeButton = document.createElement('button');
            freeButton.textContent = 'Освободить';
            freeButton.style.padding = '8px 15px';
            freeButton.style.backgroundColor = '#ff6b6b';
            freeButton.style.color = 'white';
            freeButton.style.border = 'none';
            freeButton.style.borderRadius = '3px';
            freeButton.style.cursor = 'pointer';
            freeButton.onclick = function() { 
                freeOffice(office.number); 
            };
            
            // Показываем кнопку только если офис забронирован текущим пользователем
            if (office.tenant === login) {
                buttonContainer.appendChild(freeButton);
            } else {
                const occupiedText = document.createElement('span');
                occupiedText.textContent = 'Занят другим';
                occupiedText.style.color = '#666';
                occupiedText.style.fontStyle = 'italic';
                buttonContainer.appendChild(occupiedText);
            }
        }
        
        li.appendChild(buttonContainer);
        ul.appendChild(li);
    });
    
    // Обновляем информацию о стоимости
    updateCostInfo(totalCost, userBookings);
}

// Функция для обновления информации о стоимости
function updateCostInfo(totalCost, userBookings) {
    let costInfo = document.getElementById('cost-info');
    if (!costInfo) {
        costInfo = document.createElement('div');
        costInfo.id = 'cost-info';
        costInfo.style.marginTop = '20px';
        costInfo.style.padding = '15px';
        costInfo.style.backgroundColor = '#f8f9fa';
        costInfo.style.border = '1px solid #dee2e6';
        costInfo.style.borderRadius = '5px';
        document.querySelector('main').appendChild(costInfo);
    }
    
    if (userBookings > 0) {
        costInfo.innerHTML = `
            <h3>Ваша аренда</h3>
            <p>Количество забронированных офисов: <strong>${userBookings}</strong></p>
            <p>Общая стоимость аренды: <strong style="color: #e74c3c; font-size: 1.2em;">${totalCost} руб.</strong></p>
        `;
    } else {
        costInfo.innerHTML = `
            <h3>Ваша аренда</h3>
            <p>У вас нет забронированных офисов</p>
        `;
    }
}

// Функция для бронирования офиса
function bookOffice(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'booking',
        'params': officeNumber,
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            handleError(data.error);
        } else {
            // Обновляем список после успешного бронирования
            getOfficeList();
            alert('Офис успешно забронирован!');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Произошла ошибка при бронировании');
    });
}

// Функция для освобождения офиса
function freeOffice(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'cancellation',
        'params': officeNumber,
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            handleError(data.error);
        } else {
            // Обновляем список после успешного освобождения
            getOfficeList();
            alert('Офис успешно освобожден!');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Произошла ошибка при освобождении офиса');
    });
}

// Загрузка списка офисов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    getOfficeList();
    
    // Добавляем кнопку для ручного обновления списка
    const refreshButton = document.createElement('button');
    refreshButton.textContent = 'Обновить список';
    refreshButton.style.margin = '10px 0';
    refreshButton.style.padding = '10px 20px';
    refreshButton.style.backgroundColor = '#3498db';
    refreshButton.style.color = 'white';
    refreshButton.style.border = 'none';
    refreshButton.style.borderRadius = '5px';
    refreshButton.style.cursor = 'pointer';
    refreshButton.onclick = getOfficeList;
    
    const mainElement = document.querySelector('main');
    mainElement.insertBefore(refreshButton, document.getElementById('office-list'));
});
</script>
{% endblock %}

{% block main %}
    <h1>Система бронирования офисов</h1>
    <p>Список доступных офисов:</p>
    <ul id="office-list"></ul>
{% endblock %}