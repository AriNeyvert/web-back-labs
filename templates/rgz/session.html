{% extends "rgz/base.html" %}

{% block content %}
<div style="margin-bottom: 30px;">
    <a href="{{ url_for('rgz.main') }}" class="btn" style="margin-bottom: 20px;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–µ–∞–Ω—Å–∞–º</a>
    <h2 style="color: #2c3e50;">{{ movie_title }}</h2>
    <p style="color: #7f8c8d; font-size: 1.1em;">
        üìÖ {{ session_date }} ‚è∞ {{ session_time }}
        {% if is_past %}
            <span style="color: #e74c3c; margin-left: 10px;">(–ü—Ä–æ—à–µ–¥—à–∏–π —Å–µ–∞–Ω—Å)</span>
        {% endif %}
    </p>
</div>

<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
    <h4 style="color: #2c3e50; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏</h4>
    <p style="margin: 5px 0;">
        <strong>–í–∞—à–∏ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:</strong> 
        {% if user_bookings %}
            {{ user_bookings|sort|join(', ') }}
        {% else %}
            –Ω–µ—Ç
        {% endif %}
    </p>
    <p style="margin: 5px 0; color: #7f8c8d;">
        {% if not is_past %}
            –ú–æ–∂–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ 5 –º–µ—Å—Ç. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–∞ —Å–≤–æ–µ –º–µ—Å—Ç–æ - –¥–ª—è –æ—Ç–º–µ–Ω—ã.
        {% else %}
            –≠—Ç–æ –ø—Ä–æ—à–µ–¥—à–∏–π —Å–µ–∞–Ω—Å. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.
        {% endif %}
    </p>
</div>

<h3 style="color: #2c3e50; margin-bottom: 20px;">–í—ã–±–æ—Ä –º–µ—Å—Ç</h3>

<!-- –≠–∫—Ä–∞–Ω –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ -->
<div style="text-align: center; margin-bottom: 30px;">
    <div style="background: #34495e; color: white; padding: 10px; border-radius: 5px; display: inline-block;">
        üé¨ –≠–ö–†–ê–ù üé¨
    </div>
</div>

<div class="seats-grid">
    {% for seat in range(1, total_seats + 1) %}
        {% if seat in bookings %}
            {% if bookings[seat].user_id == current_user_id %}
                <!-- –°–≤–æ–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ - –ó–ï–õ–ï–ù–´–ô -->
                <div class="seat user-booked" 
                     data-seat="{{ seat }}"
                     {% if not is_past %}onclick="cancelBooking({{ seat }})"{% endif %}
                     title="–í–∞—à–µ –º–µ—Å—Ç–æ{% if not is_past %} (–∫–ª–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏){% endif %}">
                    {{ seat }}
                </div>
            {% else %}
                <!-- –ß—É–∂–æ–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ - –ö–†–ê–°–ù–´–ô -->
                <div class="seat occupied" 
                     data-seat="{{ seat }}" 
                     title="–ó–∞–Ω—è—Ç–æ: {{ bookings[seat].name }}"
                     {% if is_admin and not is_past %}onclick="adminRemoveBooking({{ seat }})" style="cursor: pointer;"{% endif %}>
                    {{ seat }}
                </div>
            {% endif %}
        {% elif is_past %}
            <!-- –ü—Ä–æ—à–µ–¥—à–∏–π —Å–µ–∞–Ω—Å - –°–ï–†–´–ô -->
            <div class="seat past" data-seat="{{ seat }}" title="–ü—Ä–æ—à–µ–¥—à–∏–π —Å–µ–∞–Ω—Å">
                {{ seat }}
            </div>
        {% else %}
            <!-- –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ - –°–ò–ù–ò–ô -->
            <div class="seat available" 
                 data-seat="{{ seat }}"
                 onclick="bookSeat({{ seat }})"
                 title="–°–≤–æ–±–æ–¥–Ω–æ (–∫–ª–∏–∫ –¥–ª—è –±—Ä–æ–Ω–∏)">
                {{ seat }}
            </div>
        {% endif %}
    {% endfor %}
</div>

<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
    <h4 style="color: #2c3e50; margin-bottom: 10px;">–õ–µ–≥–µ–Ω–¥–∞:</h4>
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #27ae60; border-radius: 4px;"></div>
            <span><strong>–í–∞—à–∏ –º–µ—Å—Ç–∞</strong>{% if not is_past %} - –∫–ª–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã{% endif %}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #e74c3c; border-radius: 4px;"></div>
            <span>–ó–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º–∏</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #3498db; border-radius: 4px;"></div>
            <span>–°–≤–æ–±–æ–¥–Ω–æ{% if not is_past %} - –∫–ª–∏–∫ –¥–ª—è –±—Ä–æ–Ω–∏{% endif %}</span>
        </div>
        {% if is_past %}
        <div style="display: flex; align-items: center; gap: 5px;">
            <div style="width: 20px; height: 20px; background: #95a5a6; border-radius: 4px;"></div>
            <span>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
        </div>
        {% endif %}
    </div>
</div>

<script>
function bookSeat(seatNumber) {
    if (!confirm('–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ ' + seatNumber + '?')) {
        return;
    }
    
    fetch('{{ url_for("rgz.api_book") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: {{ session_id }},
            seat_number: seatNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
    });
}

function cancelBooking(seatNumber) {
    if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ ' + seatNumber + '?')) {
        return;
    }
    
    fetch('{{ url_for("rgz.api_cancel_booking") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: {{ session_id }},
            seat_number: seatNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
    });
}

{% if is_admin and not is_past %}
function adminRemoveBooking(seatNumber) {
    if (!confirm('–°–Ω—è—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ ' + seatNumber + '?')) {
        return;
    }
    
    fetch('{{ url_for("rgz.admin_remove_booking") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: {{ session_id }},
            seat_number: seatNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
    });
}
{% endif %}
</script>
{% endblock %}